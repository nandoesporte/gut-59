import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import "https://deno.land/x/xhr@0.1.0/mod.ts";

// Get environment variables
const GROQ_API_KEY = Deno.env.get("GROQ_API_KEY");

// Set up CORS headers
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  console.log("üèãÔ∏è Starting generate-workout-plan-llama function...");
  
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    console.log("Handling CORS preflight request");
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Parse request data
    const requestData = await req.json();
    const { preferences, userId, exercises = [], requestId } = requestData;
    
    console.log(`Processing workout request for user ${userId}`);
    console.log(`Request ID: ${requestId}`);
    console.log(`Number of exercises provided: ${exercises.length}`);
    
    if (!preferences) {
      throw new Error("No preferences provided in request");
    }
    
    if (!exercises || exercises.length === 0) {
      throw new Error("No exercises provided in request");
    }

    // Check if GROQ API key is available
    if (!GROQ_API_KEY) {
      console.error("No GROQ API key found in environment variables");
      throw new Error("GROQ API key is required but not configured in environment variables");
    }

    console.log("Generating workout plan with Llama 3 via Groq API...");
    const workoutPlan = await generateWorkoutPlanWithGroq(
      exercises,
      preferences,
      undefined,
      false,
      GROQ_API_KEY
    );
    
    console.log("Workout plan generated successfully");
    
    // Return the successful response with CORS headers
    return new Response(
      JSON.stringify({
        workoutPlan,
        success: true,
      }),
      {
        headers: {
          ...corsHeaders,
          "Content-Type": "application/json",
        },
      }
    );
  } catch (error) {
    console.error("Error in generate-workout-plan-llama function:", error);
    
    // Return a proper error response with CORS headers
    return new Response(
      JSON.stringify({
        error: error.message || "An error occurred while generating the workout plan",
        success: false,
      }),
      {
        status: 500,
        headers: {
          ...corsHeaders,
          "Content-Type": "application/json",
        },
      }
    );
  }
});

async function generateWorkoutPlanWithGroq(
  exercises: any[],
  preferences: any,
  customSystemPrompt?: string,
  useCustomPrompt = false,
  apiKey?: string,
  agentName = "TRENE2025"
) {
  if (!apiKey || apiKey.trim() === "") {
    throw new Error("Groq API key is required but not provided");
  }
  
  if (!apiKey.startsWith("gsk_")) {
    throw new Error("Invalid Groq API key format. Keys should start with 'gsk_'");
  }

  const defaultSystemPrompt = `Voc√™ √© ${agentName}, um excelente profissional de educa√ß√£o f√≠sica, especializado em gerar planos de exerc√≠cios personalizados. Com base nos dados fornecidos pelo usu√°rio, voc√™ deve:

Coletar os Dados do Usu√°rio:
- Idade, peso, altura, sexo.
- Objetivo (perder peso, manter peso, ganhar massa).
- N√≠vel de atividade f√≠sica (sedent√°rio, leve, moderado, intenso).
- Tipos de exerc√≠cios preferidos (for√ßa, cardio, mobilidade).
- Local de treino (academia, casa, ar livre, sem equipamentos).

Consultar o Banco de Dados:
- Analisar CUIDADOSAMENTE cada exerc√≠cio considerando sua descri√ß√£o, grupo muscular, tipo, GIF e equipamento necess√°rio.
- Escolher exerc√≠cios ideais para as condi√ß√µes f√≠sicas e objetivos espec√≠ficos do usu√°rio.
- PRIORIZAR exerc√≠cios com GIFs dispon√≠veis para melhor visualiza√ß√£o do usu√°rio.
- UTILIZAR os metadados detalhados de cada exerc√≠cio para fazer as escolhas mais adequadas.

Gerar o Plano de Exerc√≠cios:
- Criar um plano personalizado com base nos dados do usu√°rio.
- Incluir exerc√≠cios que correspondam ao objetivo, n√≠vel de atividade f√≠sica e local de treino.
- SEMPRE priorizar exerc√≠cios que possuam GIFs (gif_url n√£o vazio).
- SEMPRE analisar as descri√ß√µes dos exerc√≠cios para entender exatamente como eles funcionam.
- Garantir variedade e progress√£o adequada de exerc√≠cios.
- Considerar quaisquer condi√ß√µes de sa√∫de ou limita√ß√µes indicadas.

Para cada exerc√≠cio, incluir:
- Nome do exerc√≠cio exatamente como est√° na lista.
- ID do exerc√≠cio exatamente como est√° na lista.
- Descri√ß√£o detalhada (s√©ries, repeti√ß√µes, dura√ß√£o e carga).
- GIF demonstrativo (usando o gif_url fornecido).
- Informa√ß√µes sobre grupo muscular trabalhado.

Gerar um plano de treinos para 7 dias, incluindo:
- Exerc√≠cios, s√©ries, repeti√ß√µes, descanso e carga de treino (intensidade, volume e progress√£o).
- Um aquecimento espec√≠fico para cada tipo de treino.
- Um alongamento apropriado ap√≥s cada sess√£o.
- Adapta√ß√µes dos exerc√≠cios ao local de treino.
- Prioriza√ß√£o da queima de gordura, combinando treinos de for√ßa e cardio.
- Sugest√µes de progress√£o semanal (aumento de carga, repeti√ß√µes ou intensidade).
- Cr√≠tica do plano gerado, sugerindo melhorias se necess√°rio.

Exemplo de Carga de Treino:
- Intensidade: Moderada a alta (70-85% da capacidade m√°xima).
- Volume: 3-4 s√©ries por exerc√≠cio, com 10-15 repeti√ß√µes.
- Progress√£o: Aumentar carga ou repeti√ß√µes semanalmente (5-10%).

Formato de Sa√≠da (para cada dia):
- Dia da semana: Tipo de treino (For√ßa, Cardio, etc.).
- Aquecimento: Descri√ß√£o detalhada e espec√≠fica para o treino do dia.
- Exerc√≠cios: Nome, s√©ries, repeti√ß√µes, carga, descanso.
- Alongamento: Descri√ß√£o espec√≠fica para os m√∫sculos trabalhados.
- Carga de Treino: Intensidade, volume, progress√£o.
- Cr√≠tica e Sugest√µes: An√°lise do plano gerado.

IMPORTANTE: 
- Cada dia deve ser diferente. 
- SEMPRE priorize exerc√≠cios com GIFs dispon√≠veis.
- ANALISE as descri√ß√µes dos exerc√≠cios para entender sua execu√ß√£o.
- Considere as restri√ß√µes de equipamento e condi√ß√µes de sa√∫de.
- O plano deve ser variado e personalizado.
- Use os IDs dos exerc√≠cios fornecidos para identific√°-los corretamente.
- Crie um plano √∫nico e n√£o use templates pr√©-definidos.
- Utilize as descri√ß√µes detalhadas dos exerc√≠cios para escolher os mais adequados.`;

  const systemPrompt = useCustomPrompt && customSystemPrompt ? customSystemPrompt : defaultSystemPrompt;

  const exerciseList = exercises.map(ex => ({
    id: ex.id,
    name: ex.name,
    muscle_group: ex.muscle_group,
    exercise_type: ex.exercise_type,
    difficulty: ex.difficulty,
    equipment_needed: ex.equipment_needed,
    description: ex.description,
    gif_url: ex.gif_url,
    primary_muscles_worked: ex.primary_muscles_worked,
    secondary_muscles_worked: ex.secondary_muscles_worked,
    min_sets: ex.min_sets,
    max_sets: ex.max_sets,
    min_reps: ex.min_reps,
    max_reps: ex.max_reps,
    rest_time_seconds: ex.rest_time_seconds,
    suitable_for_conditions: ex.suitable_for_conditions,
    contraindicated_conditions: ex.contraindicated_conditions
  }));

  const userPrompt = `
Com base nas prefer√™ncias do usu√°rio a seguir, crie um plano de treino personalizado dividido por dias da semana.

PREFER√äNCIAS DO USU√ÅRIO:
- Idade: ${preferences.age} anos
- Sexo: ${preferences.gender === 'male' ? 'Masculino' : 'Feminino'}
- Peso: ${preferences.weight} kg
- Altura: ${preferences.height} cm
- Objetivo: ${translateGoal(preferences.goal)}
- N√≠vel de atividade f√≠sica: ${translateActivityLevel(preferences.activity_level)}
- Tipos de exerc√≠cios preferidos: ${translateExerciseTypes(preferences.preferred_exercise_types)}
- Local de treino: ${translateTrainingLocation(preferences)}
${preferences.health_conditions && preferences.health_conditions.length > 0 ? 
  `- Condi√ß√µes de sa√∫de: ${preferences.health_conditions.join(', ')}` : ''}

INSTRU√á√ïES DETALHADAS:
1. ANALISE CUIDADOSAMENTE as descri√ß√µes, metadados e GIFs de cada exerc√≠cio para escolher os mais adequados
2. PRIORIZE exerc√≠cios que possuem GIFs (gif_url n√£o vazio) para que o usu√°rio possa visualizar a execu√ß√£o correta
3. UTILIZE o ID correto de cada exerc√≠cio exatamente como fornecido na lista
4. Escolha exerc√≠cios adequados ao equipamento dispon√≠vel para o usu√°rio (${translateTrainingLocation(preferences)})
5. Crie um plano de treino completo para 7 dias da semana (Segunda a Domingo)
6. Para cada dia, inclua:
   - Um aquecimento espec√≠fico e detalhado para o treino do dia
   - Lista de exerc√≠cios com s√©ries, repeti√ß√µes e tempo de descanso entre s√©ries
   - Sugest√µes de intensidade considerando o n√≠vel do usu√°rio
   - Um alongamento/volta √† calma apropriado para os m√∫sculos trabalhados
   - Informa√ß√µes sobre a carga de treino: intensidade, volume e progress√£o
7. Escolha apenas exerc√≠cios da lista fornecida abaixo, analisando suas descri√ß√µes e metadados
8. Alterne os grupos musculares e tipos de exerc√≠cios durante a semana de forma equilibrada
9. Inclua pelo menos um dia de descanso ou treino leve/recuperativo
10. Adicione uma cr√≠tica e sugest√µes ao final do plano
11. Responda com um objeto JSON v√°lido seguindo o formato abaixo

EXERC√çCIOS DISPON√çVEIS:
${JSON.stringify(exerciseList).substring(0, 8000)}

FORMATO DE RESPOSTA: 
{
  "goal": "objetivo traduzido",
  "start_date": "2023-03-01",
  "end_date": "2023-03-07",
  "workout_sessions": [
    {
      "day_number": n√∫mero do dia (1-7),
      "day_name": "Nome do dia (Segunda-feira, etc.)",
      "focus": "Foco do treino (Ex: For√ßa Superior, Cardio, etc.)",
      "warmup_description": "descri√ß√£o detalhada do aquecimento",
      "cooldown_description": "descri√ß√£o detalhada da volta √† calma",
      "session_exercises": [
        {
          "exercise": {
            "id": "id do exerc√≠cio da lista",
            "name": "nome do exerc√≠cio",
            "description": "descri√ß√£o do exerc√≠cio",
            "gif_url": "url do gif do exerc√≠cio",
            "muscle_group": "grupo muscular",
            "exercise_type": "tipo de exerc√≠cio"
          },
          "sets": n√∫mero de s√©ries,
          "reps": n√∫mero de repeti√ß√µes,
          "rest_time_seconds": tempo de descanso em segundos,
          "intensity": "descri√ß√£o da intensidade recomendada"
        }
      ],
      "training_load": {
        "intensity": "descri√ß√£o da intensidade geral (Ex: Moderada 70-75%)",
        "volume": "descri√ß√£o do volume (Ex: 15 s√©ries no total)",
        "progression": "sugest√£o de progress√£o (Ex: Aumentar 5% na carga)"
      }
    }
  ],
  "critique": {
    "strengths": ["ponto forte 1", "ponto forte 2"],
    "suggestions": ["sugest√£o 1", "sugest√£o 2"],
    "notes": "notas adicionais sobre o plano"
  }
}`;

  try {
    console.log("Calling Groq API with Llama 3...");
    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "llama3-8b-8192",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        temperature: 0.7,
        max_tokens: 4096,
        response_format: { type: "json_object" }
      })
    });

    if (!response.ok) {
      const errorData = await response.text();
      console.error("Groq API Error:", errorData);
      
      if (errorData.includes("json_validate_failed")) {
        throw new Error(errorData);
      }
      
      throw new Error(`Groq API Error: ${response.status} ${response.statusText}\n${errorData}`);
    }

    const data = await response.json();
    console.log("Groq API response received");

    if (!data.choices || data.choices.length === 0) {
      throw new Error("No response from Groq API");
    }

    const content = data.choices[0].message.content;
    let workoutPlan;

    try {
      if (typeof content === 'object') {
        workoutPlan = content;
        console.log("Using pre-parsed JSON from Groq API");
      } else if (typeof content === 'string') {
        console.log("Parsing string content from Groq API");
        
        const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || 
                          content.match(/```\s*([\s\S]*?)\s*```/) || 
                          content.match(/({[\s\S]*})/);
        
        if (jsonMatch) {
          const jsonString = jsonMatch[1];
          workoutPlan = JSON.parse(jsonString);
          console.log("Successfully parsed JSON from markdown/code block");
        } else {
          console.error("No JSON pattern found in content");
          throw new Error("Could not extract valid JSON from model response");
        }
      } else {
        throw new Error(`Unexpected content type: ${typeof content}`);
      }
      
      console.log("Successfully processed workout plan response");
      
      // Verify that exercise GIFs are included where possible
      let totalExercises = 0;
      let exercisesWithGifs = 0;
      
      workoutPlan.workout_sessions.forEach(session => {
        session.session_exercises.forEach(ex => {
          totalExercises++;
          if (ex.exercise.gif_url) {
            exercisesWithGifs++;
          }
        });
      });
      
      console.log(`Generated plan includes ${exercisesWithGifs}/${totalExercises} exercises with GIFs`);
      
    } catch (parseError) {
      console.error("Error parsing workout plan JSON:", parseError);
      console.log("Raw content:", content);
      throw new Error(`Error parsing workout plan JSON: ${parseError.message}`);
    }

    // Make sure we return the workout plan or throw a clear error
    if (!workoutPlan) {
      throw new Error("Failed to generate a valid workout plan");
    }
    
    return workoutPlan;
  } catch (error) {
    console.error("Error calling Groq API:", error);
    
    if (error.message) {
      if (error.message.includes("Invalid API Key") || 
          error.message.includes("invalid_api_key")) {
        throw new Error("Invalid Groq API key. Please update your API key in the admin settings.");
      }
      
      if (error.message.includes("Validation errors")) {
        throw new Error(`Groq API key contains validation errors: ${error.message}`);
      }
      
      if (error.message.includes("json_validate_failed")) {
        throw new Error(error.message);
      }
    }
    
    throw new Error(`Failed to generate workout plan with Groq: ${error.message}`);
  }
}

// Helper functions for translating user preferences to more readable format
function translateGoal(goal) {
  const goalMap = {
    lose_weight: "Perder peso",
    maintain: "Manter peso",
    gain_mass: "Ganhar massa muscular"
  };
  return goalMap[goal] || goal;
}

function translateActivityLevel(level) {
  const levelMap = {
    sedentary: "Sedent√°rio",
    light: "Levemente ativo",
    moderate: "Moderadamente ativo",
    very_active: "Muito ativo",
    extra_active: "Extremamente ativo"
  };
  return levelMap[level] || level;
}

function translateExerciseTypes(types) {
  if (!types || types.length === 0) return "Todos";
  
  const typeMap = {
    strength: "For√ßa",
    cardio: "Cardio",
    mobility: "Mobilidade"
  };
  
  return types.map(type => typeMap[type] || type).join(', ');
}

function translateTrainingLocation(preferences) {
  if (preferences.available_equipment && preferences.available_equipment.includes("all")) {
    return "Academia com todos equipamentos";
  }
  
  if (preferences.available_equipment && preferences.available_equipment.length > 0) {
    return `Com equipamentos: ${preferences.available_equipment.join(', ')}`;
  }
  
  return "Sem equipamentos";
}
